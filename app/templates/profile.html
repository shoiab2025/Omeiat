{% extends "master_layout.html" %}
{% load static %}

{% block title %}Edit Profile{% endblock title %}

{% block layout %}
<section class="content-wrapper py-4">
    <div class="container">
        {% block h1 %}<h1 class="mb-4">Edit Profile</h1>{% endblock h1 %}

        <!-- Progress Bar -->
        <div class="mb-4">
            <div class="progress" style="height: 15x; border-radius: 10px; overflow: hidden;">
                <div id="profileProgress" class="progress-bar bg-success fw-bold" role="progressbar"
                    style="width: {{ user.profile_percentage|default:'0' }}%;">
                    {{ user.profile_percentage|default:'0' }}%
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3 shadow-lg p-4">
            <form id="profileForm" method="post" enctype="multipart/form-data" class="p-4 mb-3">
                {% csrf_token %}

                <!-- Tabs -->
                <ul class="nav nav-tabs" id="profileTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="personal-tab" data-bs-toggle="tab"
                            data-bs-target="#personal" type="button" role="tab">Personal Info</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="education-tab" data-bs-toggle="tab" data-bs-target="#education"
                            type="button" role="tab">Education</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="experience-tab" data-bs-toggle="tab" data-bs-target="#experience"
                            type="button" role="tab">Experience</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="additional-tab" data-bs-toggle="tab" data-bs-target="#additional"
                            type="button" role="tab">Additional</button>
                    </li>
                </ul>

                <div class="tab-content mt-4" id="profileTabContent">

                    <!-- Personal Info -->
                    <div class="tab-pane fade show active" id="personal" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" name="first_name" value="{{ user.first_name }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" name="last_name" value="{{ user.last_name }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Spouse Name</label>
                                <input type="text" class="form-control" name="spouse_name"
                                    value="{{ user.spouse_name }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" name="dob" value="{{ user.dob|date:'Y-m-d' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mother Tongue</label>
                                <input type="text" class="form-control" name="mother_tongue"
                                    value="{{ user.mother_tongue }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Profile Picture</label>
                                <input type="file" class="form-control" name="profile_picture">
                                {% if user.profile_picture %}
                                <div class="mt-2">
                                    <small>Current:</small>
                                    <img src="{{ user.profile_picture.url }}" height="50" class="rounded ms-2">
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Address</label>
                                <textarea class="form-control" name="address">{{ user.address }}</textarea>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary float-end" onclick="nextTab('education-tab')">Save
                            & Continue</button>
                    </div>

                    <!-- Education -->
                    <div class="tab-pane fade" id="education" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Qualification</label>
                            <input type="text" class="form-control" name="qualification"
                                value="{{ user.qualification }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Schooling</label>
                            <input type="text" class="form-control" name="schooling" value="{{ user.schooling }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Languages Known</label>
                            <input type="text" class="form-control" name="languages_known"
                                value="{{ user.languages_known }}">
                        </div>
                        <button type="button" class="btn btn-primary float-end" onclick="nextTab('experience-tab')">Save
                            & Continue</button>
                    </div>

                    <!-- Experience -->
                    <div class="tab-pane fade" id="experience" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Working Experience (Years)</label>
                            <input type="number" class="form-control" name="working_experience_years"
                                value="{{ user.working_experience_years }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Describe Your Experience</label>
                            <textarea class="form-control"
                                name="describing_experience">{{ user.describing_experience }}</textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Salary</label>
                                <input type="number" step="0.01" class="form-control" name="last_salary"
                                    value="{{ user.last_salary }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Expected Salary</label>
                                <input type="number" step="0.01" class="form-control" name="expected_salary"
                                    value="{{ user.expected_salary }}">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary float-end" onclick="nextTab('additional-tab')">Save
                            & Continue</button>
                    </div>

                    <!-- Additional -->
                    <div class="tab-pane fade" id="additional" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Reference 1</label>
                            <input type="text" class="form-control" name="reference_by_1"
                                value="{{ user.reference_by_1 }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reference 2</label>
                            <input type="text" class="form-control" name="reference_by_2"
                                value="{{ user.reference_by_2 }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Joining Availability</label>
                            <input type="text" class="form-control" name="joining_availability"
                                value="{{ user.joining_availability }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Aim of Life</label>
                            <textarea class="form-control" name="aim_of_life">{{ user.aim_of_life }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">About Family</label>
                            <textarea class="form-control" name="about_family">{{ user.about_family }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-success float-end">Submit Profile</button>
                    </div>

                </div>
            </form>
        </div>
    </div>
</section>

<script>
    function nextTab(tabId) {
        let tabTrigger = document.querySelector(`#${tabId}`);
        if (tabTrigger) {
            new bootstrap.Tab(tabTrigger).show();
        }
        updateProgress();
    }

    function updateProgress() {
        let inputs = document.querySelectorAll('#profileForm input, #profileForm textarea, #profileForm select');
        let filled = 0;
        inputs.forEach(input => {
            if (input.type !== 'file' && input.value.trim() !== '') {
                filled++;
            }
        });
        let total = inputs.length - 1; // minus CSRF
        let percent = Math.round((filled / total) * 100);
        let progressBar = document.getElementById('profileProgress');
        progressBar.style.width = percent + '%';
        progressBar.innerText = percent + '%';
    }

    document.querySelectorAll('#profileForm input, #profileForm textarea, #profileForm select')
        .forEach(el => el.addEventListener('input', updateProgress));
</script>
{% endblock layout %}